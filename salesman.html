<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salesman Order Page</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Salesman Order Page</h1>

<div class="input-section">
  <input type="text" id="customerName" placeholder="Customer Name">
  <input type="text" id="itemCode" placeholder="Item Code">
  <input type="number" id="quantity" placeholder="Quantity" min="1">
  <input type="number" id="price" placeholder="Price" min="0" step="0.01">
  <button id="addOrder">Add Order</button>
</div>

<table id="orderTable">
  <thead>
    <tr>
      <th>Customer</th>
      <th>Items</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<audio id="orderSound" src="ding.mp3" preload="auto"></audio>

<script type="module">
  import { pushOrder, listenOrders, updateOrderStatus, deleteOrder } from './firebase-script.js';

  const tableBody = document.querySelector('#orderTable tbody');
  const audio = document.getElementById('orderSound');

  function renderOrders(orders) {
    tableBody.innerHTML = '';
    orders.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.customer}</td>
        <td>${o.item} x${o.quantity} ($${o.price})</td>
        <td>${o.status}</td>
        <td>
          ${o.status !== 'Completed' ? `<button data-id="${o.id}" data-status="Ordered">Mark Ordered</button>` : ''}
          <button data-id="${o.id}" data-status="delete">Delete</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // 监听 Firebase 数据变化
  let lastPending = 0;
  listenOrders(orders => {
    renderOrders(orders);

    const pending = orders.filter(o => o.status === 'Pending').length;
    if(pending > lastPending) audio.play();
    lastPending = pending;
  });

  // 添加订单
  document.getElementById('addOrder').addEventListener('click', () => {
    const customer = document.getElementById('customerName').value.trim();
    const item = document.getElementById('itemCode').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value, 10);
    const price = parseFloat(document.getElementById('price').value);

    if(!customer || !item || !quantity || isNaN(price)) return alert('Fill all fields');

    pushOrder({ customer, item, quantity, price, status:'Pending', createdAt:Date.now() });

    document.getElementById('customerName').value='';
    document.getElementById('itemCode').value='';
    document.getElementById('quantity').value='';
    document.getElementById('price').value='';
  });

  // 订单操作
  tableBody.addEventListener('click', e => {
    if(e.target.tagName !== 'BUTTON') return;
    const id = e.target.dataset.id;
    const action = e.target.dataset.status;

    if(action === 'delete') deleteOrder(id);
    else updateOrderStatus(id, action);
  });
</script>
</body>
</html>

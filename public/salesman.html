// Salesman: 提交订单
if (isSalesman) {
  const form = document.getElementById("order-form");

  form.addEventListener("submit", e => {
    e.preventDefault();
    const data = {
      customer: form.customer.value,
      poNumber: form.poNumber.value,
      itemDesc: form.itemDesc.value,
      price: parseFloat(form.price.value),
      delivery: form.delivery.value,
      units: parseInt(form.units.value),
      timestamp: Date.now()
    };

    if (form.dataset.editId) {
      // Edit existing order
      const editRef = ref(db, `orders/${form.dataset.editId}`);
      set(editRef, data);
      delete form.dataset.editId;
    } else {
      // New order
      const ordersRef = ref(db, "orders");
      push(ordersRef, data);
    }
    form.reset();
  });
}

// 显示订单
const ordersRef = ref(db, "orders");
onValue(ordersRef, snapshot => {
  const data = snapshot.val();
  ordersContainer.innerHTML = "";
  if (data) {
    Object.entries(data).forEach(([key, order]) => {
      const div = document.createElement("div");
      div.className = "order";
      div.innerHTML = `
        ${order.customer} | ${order.poNumber} | ${order.itemDesc} | ${order.price} | ${order.delivery} | ${order.units} 
        <button data-edit="${key}">Edit</button>
        <button data-delete="${key}">Delete</button>
      `;
      ordersContainer.appendChild(div);

      // Edit
      div.querySelector(`[data-edit="${key}"]`).addEventListener("click", () => {
        form.customer.value = order.customer;
        form.poNumber.value = order.poNumber;
        form.itemDesc.value = order.itemDesc;
        form.price.value = order.price;
        form.delivery.value = order.delivery;
        form.units.value = order.units;
        form.dataset.editId = key;
      });

      // Delete
      div.querySelector(`[data-delete="${key}"]`).addEventListener("click", () => {
        const orderRef = ref(db, `orders/${key}`);
        push(ref(db, "history"), { ...order, deletedAt: Date.now() });
        set(orderRef, null);
      });
    });
  }
});

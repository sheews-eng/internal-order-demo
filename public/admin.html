<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Admin Dashboard</h1>

<table id="adminTable">
  <thead>
    <tr>
      <th>Salesman</th>
      <th>Customer</th>
      <th>Items</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<audio id="orderSound" src="ding.mp3" preload="auto"></audio>

<script type="module">
import { listenOrders, updateOrderStatus, deleteOrder } from './firebase-script.js';

const tableBody = document.querySelector('#adminTable tbody');

let allOrders = [];

listenOrders(orders => {
  allOrders = orders;
  render();
  playSoundIfPending();
});

function render() {
  tableBody.innerHTML = '';
  const grouped = {};
  allOrders.forEach(o => {
    const key = o.salesman + '||' + o.customer;
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(o);
  });

  Object.entries(grouped).forEach(([key, custOrders]) => {
    const [salesman, customer] = key.split('||');
    const itemsStr = custOrders.map(o => `${o.item} x${o.quantity} ($${o.price})`).join(', ');
    const status = custOrders.every(o=>o.status==='Completed') ? 'Completed' :
                   custOrders.every(o=>o.status==='Ordered') ? 'Ordered' : 'Pending';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${salesman}</td>
      <td>${customer}</td>
      <td>${itemsStr}</td>
      <td>${status}</td>
      <td>
        ${status!=='Completed'? `<button onclick="markCompleted('${key}')">Mark Completed</button>` : ''}
        <button onclick="deleteCustomer('${key}')">Delete</button>
      </td>`;
    tableBody.appendChild(tr);
  });
}

function playSoundIfPending() {
  const pending = allOrders.some(o => o.status==='Pending');
  if(pending) document.getElementById('orderSound').play();
}

// 全局函数
window.markCompleted = key => {
  allOrders.filter(o => (o.salesman+'||'+o.customer)===key).forEach(o => updateOrderStatus(o.id, 'Completed'));
};

window.deleteCustomer = key => {
  allOrders.filter(o => (o.salesman+'||'+o.customer)===key).forEach(o => deleteOrder(o.id));
};
</script>
</body>
</html>
